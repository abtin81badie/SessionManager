name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      # 1. Copy all project files to the server
      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          source: "."
          target: "/var/www/sessionmanager"

      # 2. SSH into server, create .env file, and restart Docker
      - name: SSH and Deploy
        uses: appleboy/ssh-action@master
        env:
          # Map GitHub Secrets to environment variables for this step
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          AES_KEY: ${{ secrets.AES_KEY }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          # These can be hardcoded here or also stored in secrets if you prefer
          JWT_ISSUER: "SessionManager"
          JWT_AUDIENCE: "SessionManagerClient"
          JWT_EXPIRY: "60"
          SESSION_MAX_CONCURRENT: "2"
          SESSION_TIMEOUT_MINUTES: "60"
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # Pass ALL variables to the script
          envs: DB_PASSWORD,JWT_SECRET,AES_KEY,ADMIN_USERNAME,ADMIN_PASSWORD,JWT_ISSUER,JWT_AUDIENCE,JWT_EXPIRY,SESSION_MAX_CONCURRENT,SESSION_TIMEOUT_MINUTES
          script: |
            cd /var/www/sessionmanager

            # --- SECURITY STEP ---
            # Create/Overwrite the .env file on the server with ALL required variables
            echo "DB_PASSWORD=$DB_PASSWORD" > .env

            # Security Keys
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "JWT_ISSUER=$JWT_ISSUER" >> .env
            echo "JWT_AUDIENCE=$JWT_AUDIENCE" >> .env
            echo "JWT_EXPIRY=$JWT_EXPIRY" >> .env
            echo "AES_KEY=$AES_KEY" >> .env

            # Admin Credentials
            echo "ADMIN_USERNAME=$ADMIN_USERNAME" >> .env
            echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> .env

            # Session Settings
            echo "SESSION_MAX_CONCURRENT=$SESSION_MAX_CONCURRENT" >> .env
            echo "SESSION_TIMEOUT_MINUTES=$SESSION_TIMEOUT_MINUTES" >> .env
            # ---------------------

            # Stop old containers
            docker-compose down

            # Start new containers (Docker will now read the complete .env file!)
            docker-compose up -d --build

            # Clean up space
            docker image prune -f
